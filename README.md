# Quantum CM4 OEM - Rugged IP67 Mission Computer / IoT Gateway
*[www.austral-elec.com](http://austral-eng.com/en/accueil-english-2/) - Intelligent Technologies for Marine, Industrial IoT and Unmanned Vehicles*  

[![QuantumUltima](/images/Quantum_cm4_rugged_IP67_Raspberry_PI.png)](http://austral-eng.com/en/quantum-cm4-oem-en/)

<table border="0">
 <tr>
    <td><b style="font-size:30px">Key Features</b></td>
    <td><b style="font-size:30px">Go Fast</b></td>
 </tr>
 <tr>
    <td>The <b>Quantum CM4 is a SWaP platform : Industrial with a wide temperature range, marinized IP67, miniaturized and very lightweight, very low power consumtion</b>. It integrates a powerful quad core ARM processor, many Industrial, Marine, and Automotive field buses, Galvanic isolation, Protections, Watchdog, RTC with GNSS Time synchronisation, Wireless and a huge storage for your datalogs.<ul>
      <li><b>Field Interfaces :</b> <ul>
        <li><b>M12 Connectors</b> : Cables available on the shelf (Profinet, NMEA2000/DeviceNet/CANopen... standards cables)</li>
        <li><b>Wireless</b> : WIFI, Bluetooth, BLE</li>
        <li><b>Ethernet</b> : Modbus TCP, Profinet, ETherNet/IP, BACnet, OPC-UA, MQTT, DDS, Websocket, ZMQ, UDP, TCP, NMEA OneNet...</li>
        <li><b>2xCANbus</b> : NMEA2000, J1939, CANopen...</li>
        <li><b>3xSerials</b> : RS232, RS485, RS422, Modbus RTU, NMEA0183...</li>
        <li><b>Internal mini PCIe expansion slot</b> : USB2.0, SPI, GPIOs</li>
      </ul></li>
      <li><b>Hardware expansion flexibility :</b> <a href="mailto:contact@austral-eng.com">Contact us</a><ul>
        <li><b>Global wireless IoT</b> : LoRaWAN, SigFox, Zigbee, Xbee, Zwave, 4G/LTE, NB-IoT, Iridium SBD, <a href="https://swarm.space/">SpaceX Swarm</a>, <a href="https://www.kineis.com/en/">Kineis</a>...</li>
        <li><b>AI accelerator</b> : Hailo-8, Google Coral...</li>
      </ul></li>
      <li><b>Easy software installation and the support of the community</b> :<ul>
        <li><b>Any OS</b> : Linux (Debian pre-installed), RTOS (VxWorks, FreeRTOS...), Android, Windows</li>
        <li><b>Any frameworks</b> : Robotics (ROS, ROS2, MOOS-IvP), PLC (CoDeSys), IoT (Node-Red), AI (TensorFlow, PyTorch)...</li>
        <li><b>Any languages</b> : C/C++/Qt, Python, JS, Rust, Java, C#, Go...</li>
      </ul></li>        
    </ul></td>
    <td><ul>
     <li><b>Makes it as easy as possible to build your next smart project operating in hostile environment</b> with a solution <b>100% COMPATIBLE WITH THE RASPBERRY PI ECOSYSTEM</b>, designed for professional use, suitable for real-time applications and browser-based remote displays.</li>
     <li><b>Shrink your team and schedule :</b> Focus on your core business by using a yet proven rugged hardware and a mainstream software solution. Develop from day one and take advantage of the support and examples of the largest developer community.</li>
     <li><b>Hardware flexibility :</b> Choose the memory, the storage, the WIFI option from a single unit. We can customize the expansion board, put your logo or add functionality for very low volumes. If a high level of integration is required, the Quantum CM4 bare electronic boards can also be integrated into your system (only 20g).</li>
     <li><b>Develop at warp speed with free tools:</b> Connect an instrument to the cloud, datalog, make a web live data dashboard, troubleshoot... in minutes and accessible to all !!!. it's possible. If it is suitable for your application, you can freely use <a href="https://github.com/austral-electronics/wiki/wiki/Quantum-SDK">Red Carpet - IoT Software Suite</a>, our fast system integration solution based on <a href="https://nodered.org/">Node-RED</a> visual flow creator, which offers you a library of nearly 4000 <a href="https://github.com/austral-electronics/wiki/wiki/Quantum-nodes-collection">nodes</a> to connect everything.</li>
    </ul></td>
 </tr>
</table>

<!--- 
- **Makes it as easy as possible to build your next smart project operating in hostile environment** with a solution **100% compatible with the Raspberry Pi Ecosystem** and designed for professional use and suitable for real-time applications and browser-based remote displays.  
- **Shrink your team and schedule :** Focus on your core business by using a yet proven rugged hardware and a mainstream software solution. Develop from day one and take advantage of the support and examples of the largest developer community.  
- **Hardware flexibility :** Choose the memory, the storage, the WIFI option from a single unit. We can customize the expansion board, put your logo or add functionality for very low volumes. If a high level of integration is required, the Quantum CM4 bare electronic boards can also be integrated into your system (only 20g).
- **Develop at warp speed with free tools:** Connect an instrument to the cloud, datalog, make a web live data dashboard, troubleshoot... in minutes and accessible to all !!!. it's possible. If it is suitable for your application, you can freely use [Red Carpet - IoT Software Suite](https://github.com/austral-electronics/wiki/wiki/Quantum-SDK), our fast system integration solution based on [Node-RED](https://nodered.org/) visual flow creator, which offers you a library of nearly 4000 [nodes](https://github.com/austral-electronics/wiki/wiki/Quantum-nodes-collection) to connect everything.  

## Overview <a name="overview"></a>

The **Quantum CM4 is a SWaP platform : Industrial with a wide temperature range, marinized IP67, miniaturized and very lightweight, very low power consumtion**. It integrates a powerful quad core ARM processor, many Industrial, Marine, and Automotive field buses, Galvanic isolation, Protections, Watchdog, RTC with GNSS Time synchronisation, Wireless and a huge storage for your datalogs.

- ***Field Interfaces** :*  
  - **M12 Connectors** : Cables available on the shelf
  - **Wireless** : WIFI, Bluetooth, BLE 
  - **Ethernet** : Modbus TCP, Profinet, ETherNet/IP, BACnet, OPC-UA, MQTT, DDS, Websocket, ZMQ, UDP, TCP, NMEA OneNet...
  - **2xCANbus** : NMEA2000, J1939, CANopen...
  - **3xSerials** : RS232, RS485, RS422, Modbus RTU, NMEA0183...
  - **Internal mini PCIe expansion slot** : USB2.0, SPI, GPIOs

- ***Hardware expansion flexibility** :*   [Contact us](http://austral-eng.com/contact/)  
  - **Global wireless IoT** : LoRaWAN, SigFox, Zigbee, Xbee, Zwave, 4G/LTE, NB-IoT, Iridium SBD, [SpaceX Swarm](https://swarm.space/), [Kineis](https://www.kineis.com/en/)... 
  - **AI accelerator** : Hailo-8, Google Coral... 

- ***Easy software installation and the support of the community** :*
  - **Any OS** : Linux (Pre-installed), VxWorks, Windows IoT...
  - **Any frameworks** : Robotics (ROS, ROS2, MOOS-IvP), PLC (CoDeSys), IoT (Node-Red), AI (TensorFlow, PyTorch)...
  - **Any languages** : Pre-installed C/C++/Qt, Python. Easy installation of NodeJS, Rust, Java, C#, Go...   

- ***Longevity** :* The internal CM4 Module will remain in production until at least January 2028. The phylosophy of the Raspberry PI foundation is to follow the technology by making its models evolve every 3 years, and by being careful to remain compatible in hardware and software.
-->
## Applications <a name="applications"></a>

The Quantum CM4 OEM is designed for ITAR-free, **SWaP-sensitive and real-time applications using remote HMI**. It will be embedded into a third-party system in a harsh environment, like wearable edge computing, boats, vehicles, drones, machines, outdoor and underground platforms… and for a wide range of use cases:
- Interfacing sensors, actuators and PLCs
- Data collection, Black box
- Marine IOT, IIOT, Cloud
- IA, Robotics, Command control, Guidance
- Asset tracking, Machine monitoring, Energy Management
- Building, boat and vehicle automation, Security systems, Climate control
- HTML5 Multifunction Displays Dashboards, Voice Assistant

**Sectors** : Marine, Industry 4.0, Drones, Robotics, Off-Highway Vehicles, Smart Farming …

**Pricing & Ordering** : [Link to Austral Electronics page](http://austral-eng.com/en/quantum-cm4-oem-en/)

## Table of contents
<!--- 
[Overview](#overview)  
[Applications](#applications)  
-->
1. [Hardware](#hardware)
2. [Operating system](#os)
3. [First connection](#connect_ssh)
4. [Install Debian](#debian)  
4.1. [Download a Debian image](#download_debian)  
4.2. [Program the Micro SD-CARD](#prog_sd)  
4.3. [Program the EMMC](#prog_emmc)  
4.4. [Network Boot/Download](#net_boot)  
5.5. [Create your own Debian image from scratch](#debian_from_scatch)  
5.6. [Configuration current issues](#config_issues)  
5. [Test the peripherals](#peripherals)  
5.1. [Get the system configuration](#get_conf)  
5.2. [Change the system configuration](#change_conf)  
5.3. [Ethernet](#eth)  
5.4. [Wifi](#wifi)  
5.5. [Samba file server](#samba)  
5.6. [Serials](#serials)  
5.7. [CANbus](#canbus)  
5.8. [Real Time Clock](#rtc)  
5.9. [Logo backlight](#led)  
5.10. [Bluetooth](#ble)  
5.11. [Watchdog](#wd)  
5.12. [Optional PWM](#pwm)  
5.13. [Thermal Stress Test](#thermal)
6. [Applications](#applications)  
6.1. [Remove Applications](#rem_app)  
6.2. [Tools](#tools)  
6.3. [Protocols](#protocols)  
6.4. [Databases](#databases)  
6.5. [Install Frameworks](#frameworks)  
7. [Others Operating Systems Links](#oos)  
8.   [Disclaimers](#disclamers)

## 1. Hardware <a name="hardware"></a>

**Download a PDF Hardware specifications and installation** : [Here](https://github.com/austral-electronics/QuantumUltima/tree/main/pdf/Quantum_OEM_02_Brief.pdf)

![QuantumCM4spec](/images/QuantumCM4specLR.png)

## 2. Operating system <a name="os"></a>
Quantum CM4 is a headless product, it is designed to have its man-machine interface distributed on all types of web browsers, marine MFD displays and industrial touch panels. If you don't have real time constraints, you can of course install a linux, android or windows desktop distribution and develop via VNC but this is not the main purpose of this calculator.  
We recommend the use of a [Debian](https://www.debian.org/index.en.html) distribution if your system is not deployed in large quantities and you do not have a Linux specialist in your team. In the other cases, [Austral Electronics](http://austral-eng.com/en/accueil-english-2/) in partnership with [Linatsea](https://www.linatsea.fr/) can accompany you in the creation of a distribution adapted to your need:  Buildroot, Yocto, Vxworks, [Redpesk Marine Grade Linux](https://docs.redpesk.bzh/docs/en/master/getting_started/docs/overview.html), [Victron Energy Venus OS](https://github.com/victronenergy/venus/wiki/raspberrypi-install-venus-image#supported-platforms), [Automotive Grade Linux](https://www.automotivelinux.org/) (AGL), [Ubuntu Server](https://ubuntu.com/download/raspberry-pi), Over-the-air (OTA) update : [Contact us](http://austral-eng.com/contact/)

[Usefull links for others Operatings Systems](#oos)

## 3. First connection <a name="connect_ssh"></a>
With the pre-installed Debian or the configuration script settings :

Change the IP of your machine to 192.168.100.X  
Power-up the Quantum and wait 20s for the end of the boot.  
Launch a ssh console :

    ssh quantum@192.168.100.100
The default password is : pass

On windows, you can open a ssh console using : 
* DOS - On the command prompt, type 'cmd'
* PowerShell
* [MobaXterm Free](https://mobaxterm.mobatek.net/download.html) - Automatic password entry, File browser & Editor, vnc...
* [putty](https://putty.org/) - To automate the password entry, the create a .bat shortcut : putty.exe -ssh quantum@192.168.100.100 -pw pass
    
Change the IP : [link](#eth)

Access/Modify to the samba share : [link](#samba)

## 4. Install Debian <a name="debian"></a>
In order to take advantage of the huge developer community on Raspberry PI, a great [documentation](https://www.raspberrypi.com/documentation/computers/os.html#introduction) and a Tier 3 support. The Quantum CM4 Processor is preinstalled with a [Debian Linux](https://www.debian.org/index.en.html) optimized by the Raspberry PI Foundation and configured for the Quantum CM4 hardware. The OS comes with over 35,000 packages: precompiled software bundled in a nice format for easy installation. You can reinstall Debian from scratch by following this procedure.  
Debian Long Term Support (LTS) is a project to extend the lifetime of all Debian stable releases to (at least) 5 years.  
The choice of the version depends on the deployment date of your system.  
[Debian (future) LTS Releases, Supported by security and release teams:](https://wiki.debian.org/fr/LTS)  
* Debian 10 “Buster”      July, 2022 to June, 2024
* Debian 11 “Bullseye”    July, 2024 to June, 2026

### 4.1. Download a Debian image <a name="download_debian"></a>
* Debian 11.3 "Bullseye" Headless PREEMPT-RT, Ready-to-use (Rolling Release) : (coming soon)
* Debian 10 "Buster" Headless PREEMPT-RT, Ready-to-use (LTS) : (coming soon)
* Debian 11.3 "Bullseye" Headless PREEMPT-RT, to configure (Rolling Release) : [here](https://downloads.raspberrypi.org/raspios_lite_arm64/images/raspios_lite_arm64-2022-04-07/)
* Debian 10 "Buster" Headless PREEMPT-RT, to configure (LTS) : [here](https://downloads.raspberrypi.org/raspios_lite_arm64/images/raspios_lite_arm64-2021-05-28/)

### 4.2. Program the Micro SD-CARD  <a name="prog_sd"></a>
* [Install the Imager, version >=1.7.2](https://downloads.raspberrypi.org/imager/)
* [Download the .xz image of Debian 11.3 "Bulleye"](https://downloads.raspberrypi.org/raspios_lite_arm64/images/raspios_lite_arm64-2022-04-07/)
* Insert a Micro SD-Card in an USB3.0 Card Reader
* Launch the imager
* Choose a personalized image and select the downloaded image
* Select the SD-card
* Click on the gear icon to configure to the Advanced Options  

![Advanced Options](/images/AdvancedOptions.png)
### 4.3. Program the EMMC <a name="prog_emmc"></a>
If you have a Quantum version EMMC and not micro SD-card, the procedure is slightly different.  
On windows, install [rpiboot](https://github.com/raspberrypi/usbboot/raw/master/win32/rpiboot_setup.exe)  
Connect the Quantum to Windows using a USB cable connected to the USB Slave port.  
Boot the Quantum with the EMMC_BOOT switch ON.  
The EMMC appears as a disc on windows that you have to select in the imager.  
Switch back to OFF after programming.  

### 4.4. Network Boot/Download <a name="net_boot"></a>

If you need to boot from a server or update remotely, a single or multiple Quantum, you will need a Network Bootloader.

The Raspberry PI fundation [bootloader](https://www.raspberrypi.com/news/network-install-beta-test-your-help-required/) it is not suitable for a headless hardware. [More](https://github.com/raspberrypi/documentation/blob/develop/documentation/asciidoc/computers/raspberry-pi/boot-net.adoc)

We recommend using [Pre-boot eXecution Environment](https://fr.wikipedia.org/wiki/Preboot_Execution_Environment) (PXE). [Video1](https://www.youtube.com/watch?v=YSyM_k1_QGM) - [Video2](https://www.youtube.com/watch?v=_usdzVv-vvk) - [Link1](https://hackaday.com/2019/11/11/network-booting-the-pi-4/) - [Link2](https://williamlam.com/2020/07/two-methods-to-network-boot-raspberry-pi-4.html)

### 4.5. Create your own Debian image from scratch <a name="debian_from_scatch"></a>

If you are not a Linux expert, the following example is the easiest way to create and deploy your own linux distribution with your applications pre-installed. You only need to customize a configuration script and somes settings (IP, password...).

**Get Debian an image :**
* Debian 11.3 "Bullseye" Headless PREEMPT-RT, to configure (Rolling Release) : https://downloads.raspberrypi.org/raspios_lite_arm64/images/raspios_lite_arm64-2022-04-07/
* Debian 10 "Buster" Headless PREEMPT-RT, to configure (LTS) : https://downloads.raspberrypi.org/raspios_lite_arm64/images/raspios_lite_arm64-2021-05-28/

**Program the Micro SD-CARD or EMMC:**

See above

**Configure the default image for the Quantum CM4 Platform:**

Verify the internet connection of the Quantum CM4 :

    ping -q -c1 google.com &>/dev/null && echo online || echo offline

If you are 'Online', you can download and launch configuration script, otherwise verify your Ethernet or Wifi configuration :

    bash <(curl -sL https://raw.github.com/austral-electronics/QuantumCM4/main/script/configure.sh)

Operations realized by the script :  
* Update and upgrade Debian
* Configure Ethernet & Wifi
* Install peripherals libraries and configure them (I2C, SPI, RTC, CANbus, Serials, GPIO...)
* Install and configure Samba
* Configure Avahi (Bonjour/Zeroconf) for marine MFD Displays
* On request, install and configure for real-time usual services or applications in embedded systems:
  * Dev Tools:
    * C/C++
    * [Qt5](https://www.qt.io/)
    * [Python3](https://www.python.org/about/)
  * [Red Carpet - IoT Software Suite](https://github.com/austral-electronics/wiki/wiki/Quantum-SDK) :
    * [Node.JS](https://nodejs.org/en/about/) (Asynchronous event-driven JavaScript runtime)
    * [Node-Red](https://nodered.org/) (Low Code programming)
    * [InfluxDB](https://www.influxdata.com/products/influxdb-overview/) (Time Series Database)
    * [Grafana](https://grafana.com/) (Operational dashboards)
    * [Mosquitto](https://mosquitto.org/) (MQTT broker)
    * [GPSD](https://gpsd.gitlab.io/gpsd/) (GNSS Time, GNSS To the net)

**Deployment : Shrink and backup the image:**

Read the uSD-Card with [win32 Disk Imager](https://sourceforge.net/projects/win32diskimager/files/latest/download) and a USB-uSD Interface.
In 'Device' select the partition /boot -> G: Then 'Read'

[Shrink](https://github.com/Drewsif/PiShrink) the image (that will then resize to the max size of the SD card on boot)

Installation (Linux machine / Win10/11 WSL2 or virtual box):

    wget https://raw.githubusercontent.com/Drewsif/PiShrink/master/pishrink.sh
    chmod +x pishrink.sh
    sudo mv pishrink.sh /usr/local/bin

Usage :

    sudo pishrink.sh xxxx.img
    
You can backup / share this compressed image.

### 4.6. Configuration current issues <a name="config_issues"></a>
#### I can't find my IP address
By default the ip address is static and is 192.168.100.100, if you have modified and lost the IP Address :

* Use bonjour Protocol :

Install bonjour service on windows : https://support.apple.com/kb/DL999?locale=en_US

    ssh quantum@quantum.local   -> Default password=austral
    ifconfig

* Use nmap :

Install nmap : https://nmap.org/download.html
Launch nmap to scan all DHCP ip addresses

    nmap -sn 192.168.100.0/24

#### I have an SSH error 'ECDSA host key for quantum.local has changed '
    ssh-keygen -R quantum.local

#### The configure.sh script don't work

* Verify the internet connection of the Quantum CM4:

    ping -q -c1 google.com &>/dev/null && echo online || echo offline
    
* If you modify configure.sh script with an editor you may have a CRLF problem, you can clean it with :
    
    wget https://raw.github.com/austral-electronics/QuantumCM4/main/script/clean_script.sh -O - | bash

## 5. TEST THE PERIPHERALS <a name="peripherals"></a>   
### 5.1. Get the system configuration <a name="get_conf"></a>

Linux :

    uname -a                -> Linux Version (quantum 5.15.32-v8+ #1538 SMP PREEMPT Thu Mar 31 19:40:39 BST 2022 aarch64 GNU/Linux)
    cat /etc/os-release     -> Debian version (PRETTY_NAME="Debian GNU/Linux 11 (bullseye)")
    cat /etc/debian_version -> Debian version (11.3)
    
Memories :

    cat /etc/fstab      -> Partitions
    df -h               -> Disk usage
    
Cores :

    htop                        -> Processors & Memory usage
    cat /proc/cpuinfo           -> Processors models
    vcgencmd measure_temp       -> Cores temperature
    vcgencmd measure_clock arm  -> Current clock speed. you can try : arm core h264 isp v3d uart pwm emmc pixel vec hdmi dpi
    vcgencmd measure_volts core -> Current Cores voltage
    cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq -> Current clock
    cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freq -> Min Clock
    cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq -> Max Clock
    
 Debug :
 
     dmesg                      -> View the system Log

### 5.2. Change the system configuration <a name="change_conf"></a>
    sudo raspi-config
    
Enable/Disable a config in command line [here](https://pi3g.com/fr/2021/05/20/enabling-and-checking-i2c-on-the-raspberry-pi-using-the-command-line-for-your-own-scripts/)
    
[Documentation](https://www.raspberrypi.com/documentation/computers/configuration.html)
    
### 5.3. Ethernet <a name="eth"></a>
by default the ip address is static and is 192.168.100.100

To change IP :

    sudo nano /etc/dhcpcd.conf
    
    # Example static IP configuration:
    interface eth0
    static ip_address=192.168.100.100/24

To use DHCP :

    # Example static IP configuration:
    #interface eth0
    #static ip_address=192.168.100.100/24

### 5.4. Wifi <a name="wifi"></a>
To get the wifi IP address:

    ipconfig
    
To get the access point status:

    iwconfig
### 5.5. Samba file server <a name="samba"></a>

The default samba setting share the /home/quantum/git directory for development purposes.

We recommend adding a network drive 'Q' on Windows :
>Address: \\\\AUSTRAL\quantum  
>Login: quantum  
>password: pass (default)

To add or change a share directory:
 
    sudo nano /etc/samba/smb.conf
    
Add at the end of smb.conf:

    [myShare]
    path = /myDirectory
    writeable = yes
    create mask = 0700
    directory mask = 0700
    public = no 

Allow users to access share folders or change the default password:

    sudo smbpasswd -a quantum    -> Default password : pass

Restart service after smb.conf modifications :

    sudo systemctl restart smbd

Service status :

    sudo systemctl status smbd.service

Stop the Samba service :

    sudo systemctl stop smbd.service

Get samba configuration :

    testparm -s
    
The default smb.conf is set for the WORKGROUP domain, to get the windows domain name :

    net config workstation

### 5.6. Serials <a name="serials"></a>

Pinouts :

![Pinouts](/images/Pinouts.png)

List all the ports:

    ls -l /dev/tty*

You must see the 3 used ports:

    /dev/ttyS0
    /dev/ttyAMA1
    /dev/ttyAMA2

You can test the ports with minicom :

    sudo apt update -y
    sudo apt install minicom -y
    sudo minicom -D /dev/ttyS0
    
You can also test in bash command :

**COM2 = ttyAMA1 : RS232 port (uart3 with CTS for PPS input on GPIO6) :**

    # Configure
    stty -F /dev/ttyAMA1 speed 4800 cs8 -cstopb -parenb

    # Read
    cat /dev/ttyAMA1

    # Write
    echo -e "TX COM2 Working \x0D\x0A" > /dev/ttyAMA1

**COM3 = ttyAMA2: RS232 port (uart5) :**

    # Configure
    stty -F /dev/ttyAMA2 speed 4800 cs8 -cstopb -parenb

    # Read
    cat /dev/ttyAMA2

    # Write
    echo -e "TX COM3 Working \x0D\x0A" > /dev/ttyAMA2
    
**COM1 = ttyS0 : Multifunction port (uart1 with hardware RTS1 and a RS485/MODBUS/422 selection) :**

By default this port is configured in RS232 with RTS.  
RS485_MODE (GPIO24) is used for RS485/MODBUS/RS422 selection.  
RTS1 (GPIO17) is used for the high/low impedance control in RS485/MODBUS mode.  

!!!! Warning : If you have an isolated hardware, connect your ground wire to COM1-GND !!!!

    # Set RS485_MODE (GPIO24) ports as output
    echo "24" > /sys/class/gpio/export
    echo "out" > /sys/class/gpio/gpio24/direction
    
    # Config in RS232 mode 
    echo "0" > /sys/class/gpio/gpio24/value
    
    # Config in RS485 mode
    echo "1" > /sys/class/gpio/gpio24/value    
   
    # Configure
    stty -F /dev/ttyS0 speed 4800 cs8 -cstopb -parenb
    
    # Read
    cat /dev/ttyS0

    # Write
    echo -e "TX COM1 Working \x0D\x0A" > /dev/ttyS0

**Replace COM1 with the linux serial console :**

For debug purposes, you can activate/desactivate a debug console with 

    sudo raspi-config 

Interface Options ->  Serial Port -> Shell accessible over serial -> Yes

### 5.7. CANbus <a name="canbus"></a>
Verify the configuration :

     ifconfig

You must see can0, can1 and vcan0 peripherals, and rx/tx packets status.
Alias :
* can0 -> CAN2 Isolated - Secondary CANbus port (near Serials M12)
* can1 -> CAN1 with PowerIn - Main CANbus port (near Ethernet M12)
* vcan0 -> Virtual CANbus for development

You can also see the status with :

    ip -s -d link show can0
    ip -s -d link show can1

You can check for a hardware problem with :

    dmesg | grep -i -E "(mcp|spi)"

Must give :

    [    8.719339] mcp251x spi1.2 can0: MCP2515 successfully initialized.
    [    8.745038] mcp251x spi0.1 can1: MCP2515 successfully initialized.

Change baudrate :

    sudo /sbin/ip link set can0 up type can bitrate 250000
    
Receive sentences test :

    candump can1       -> CAN1 (PowerIn near Ethernet M12)
    candump can0       -> CAN2 (Isolated near Serials M12)
    
Transmit sentences test :

    cansend can1 7DF#0201050000000000
    cansend can0 7DF#0201050000000000
    
Pthon example : https://www.waveshare.com/wiki/2-CH_CAN_HAT#.E3.80.90Python_example.E3.80.91

### 5.8. Real Time Clock <a name="rtc"></a>
To verify the RTC chip response on I2C bus :
 
    sudo i2cdetect -y 1

You must see UU or 68 at Address 0x68

To program the RTC :

    sudo hwclock -D -r
    date
    sudo hwclock -w
    sudo hwclock -r

### 5.9. Logo backlight <a name="led"></a>

To test the LED :

    # Set Led port as output
    echo "27" > /sys/class/gpio/export
    echo "out" > /sys/class/gpio/gpio27/direction

    # Led ON 
    echo "1" > /sys/class/gpio/gpio27/value

    #led OFF
    echo "0" > /sys/class/gpio/gpio27/value
    
### 5.10. Bluetooth <a name="ble"></a>

Bluetooth allows you to connect a GNSS, a Remote control... to the Quantum CM4 or transform it to a voice assistant.  
[How to](https://howchoo.com/pi/bluetooth-raspberry-pi#setting-up-bluetooth-using-a-terminal-or-ssh-connection)

<!---    
## 5. INSTALL THE SDK ON WINDOWS
### 4.1 Visual Code
### 4.2 C/C++ Cross Compiler
### 4.3 Qt
### 4.4 Python
### 4.5 Cross Debugging
### 4.6 Git
### 4.7 Templates
-->

### 5.11. Watchdog and OverTemperature <a name="wd"></a>

Tutorial : https://medium.com/@arslion/enabling-watchdog-on-raspberry-pi-b7e574dcba6b

Settings :

    sudo nano /etc/watchdog.conf
    sudo nano /etc/default/watchdog

Start the service :

    sudo systemctl start watchdog
    
### 5.12. Optional PWM <a name="pwm"></a>

COM3-TXD (TXD5) output may be use as PWM0 (PIN 6 of the M12 connector).  
Note: With a factory hardware modification PWM0 can also replace PWR-OUT on the PIN5 of the M12 connector.

Contact us for more information.

### 5.13. Thermal Stress Test <a name="thermal"></a>

If your installation does not follow the recommendations (bare boards, flat mounting...), you must do a thermal test under load.

Stress the CPUs:

    sudo apt install stress-ng mesa-util
    stress-ng --cpu 0 --cpu-method fft

Open 3 others consoles and verify the CPUs Temperature, the current cores clocks speed (1500Mhz) and the throttle:

    watch -n 1 vcgencmd measure_temp
    watch -n 1 vcgencmd measure_clock arm
    watch -n 1 vcgencmd get_throttled

Throttle Status :

    0: under-voltage
    1: arm frequency capped
    2: currently throttled 
    16: under-voltage has occurred
    17: arm frequency capped has occurred
    18: throttling has occurred

under-voltage occurs when voltage drops below 4.63V. The Quantum is throttled
arm frequency capped occurs with temp > 80'C
over-temperature occurs with temp > 85'C. The Quantum is throttled
Throttling removes turbo mode, which reduces core voltage, and sets arm and gpu frequencies to non-turbo value.
Capping just limits the arm frequency (somewhere between 600MHz and 1200MHz) to try to avoid throttling.
If you are throttled and not under-voltage then you can assume over-temperature. (confirm with vcgencmd measure_temp).

Notes : 
* The CPU will reduce the clock rate to try and keep its internal temperature below 85°C. Once cooled down, the clock is restored to its original frequency.
* Optimal RF Wireless performance is between -20°C and +75°C .

You can view the 3 informations using a bash script :

    while :
    do
      vcgencmd measure_clock arm
      vcgencmd measure_temp
      vcgencmd get_throttled
      sleep 1
      echo ''
    done

You can also lauch a python script to log a long test in a csv file :

    from gpiozero import CPUTemperature
    from time import sleep, strftime, time
    
    with open("/home/quantum/cpu_temp.csv", "a") as log:
    while True:
        cpu = CPUTemperature()
        log.write("{0},{1}\n".format(strftime("%Y-%m-%d %H:%M:%S"),str(cpu.temperature)))
        sleep(1)
    
## 6. Applications<a name="applications"></a> 
### 6.1. Remove Applications <a name="rem_app"></a>
Remove applications you installed with apt-get with:

    sudo apt-get –purge remove APPNAME    (replace APPNAME with the name of the app you want to remove)

To remove possible application orphans:

    sudo apt-get autoremove –purge

### 6.2. Tools <a name="tools"></a>
Minicom is a simple terminal usefull to scan serials

    sudo apt update -y
    sudo apt install minicom -y
    sudo minicom -D /dev/ttyS0
    
### 6.3 Protocols <a name="protocols"></a>

  * [Lely CANOpen](https://opensource.lely.com/canopen/docs/installation/)
  * [Signal K](https://signalk.org/) (Open marine data standard)
    
### 6.4 Databases <a name="databases"></a>

  * [WARP10](https://www.warp10.io/content/03_Documentation/02_Installation/01_Standalone) (Optimized for Geo Time Series)

### 6.5 Install Frameworks <a name="frameworks"></a>

  * [CoDeSys](https://help.codesys.com/webapp/_rbp_install_runtime;product=CODESYS_Control_for_Raspberry_Pi_SL;version=3.5.12.0) (Leading IEC 61131-3 development system in factory automation with powerful functions for fieldbus configuration, visualization, motion control and safety.)
  * [ROS2](https://docs.ros.org/en/foxy/index.html) (The Robot Operating System is a set of software libraries and tools that help you build robot applications.)
  * [moss-ivp](https://oceanai.mit.edu/moos-ivp/pmwiki/pmwiki.php?n=Main.HomePage) (Set of open source C++ modules for providing autonomy on robotic platforms, in particular autonomous marine vehicles.)
  * [Node-Red](https://nodered.org/docs/getting-started/raspberrypi) (Low-code programming for event-driven applications for IoT)
  * [TensorFlow Install](https://qengineering.eu/install-tensorflow-2.7-on-raspberry-64-os.html) [TensorFlow](https://github.com/Qengineering/TensorFlow-Raspberry-Pi_64-bit) (AI)
  * [PyTorch](https://pytorch.org/tutorials/intermediate/realtime_rpi.html) (AI)

## 7. Others Operating systems links<a name="oos"></a>

  * VxWorks (Chosen for the Mars rovers) :
    * [VxWorks Installation](https://labs.windriver.com/downloads/wrsdk-vxworks7-docs/README-raspberrypi4b.html)
    * [VxWorks SDK](https://forums.windriver.com/t/vxworks-software-development-kit-sdk/43)
    * [VxWorks Layer for ROS2](https://github.com/Wind-River/vxworks7-layer-for-ros2)
  * RTOS :
    * [FreeRTOS](https://github.com/jameswalmsley/RaspberryPi-FreeRTOS)
    * [ChibiOS](https://github.com/steve-bate/ChibiOS-RPi)
  * Roll your own small footprint embedded Linux :
    * [Buildroot Boot in 5 sec video](https://www.youtube.com/watch?v=yxj8ynXXgbk)  
    * [Buildroot Github](https://github.com/buildroot/buildroot/blob/8d07baab43b5624ad6d73ee58f5a9d4ab8b27049/board/raspberrypi/readme.txt)  
    * [Yocto Tutorial](https://jumpnowtek.com/rpi/Raspberry-Pi-4-64bit-Systems-with-Yocto.html)  
  * Redpesk (Marine Grade Linux) :
    * [Redpesk Image - Marine Grade Linux](https://download.redpesk.bzh/redpesk-lts/arz-1.0/images/smack/minimal/aarch64/generic/latest/)  
  * AGL (Automotive grade Linux) :
    * [AGL Tutorial - Automotive Grade Linux](https://wiki.automotivelinux.org/agl-distro/agl-raspberrypi)  
    * [AGL Image](https://download.automotivelinux.org/AGL/snapshots/master/latest/raspberrypi4/)
  * Victron's Venus OS (Energy management) :
    * [Venus OS](https://github.com/victronenergy/venus/wiki/raspberrypi-install-venus-image)

## Disclaimers <a name="disclamers"></a>
*Copyright (C) 2022 [Austral Electronics SARL](http://austral-eng.com/en/accueil-english-2/). Changes to the specifications and features in this manual may be made by Austral without prior notice. Specifications and information provided in this manual are for informational use only. Austral assumes no responsibility or liability for any errors or inaccuracies that may appear in this manual including the product & / or software. All trademarks mentioned in this manual are property of their respective owners. This product contains copyrighted software which are released under multiple open source licenses including but not limited to the GNU GPL, LGPL, and MIT BSD licenses. Such software is provided without warranty. Copies of these licenses are included in the software itself in further detail. For the latest up to date information, please visit our Github Repository at https://github.com/austral-electronics/QuantumCM4*
  
![Logo](/images/LogoAustral.png)
